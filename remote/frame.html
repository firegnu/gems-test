<!DOCTYPE html>
<html>
<head>
  <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1"
  />
  <meta charset="utf-8" />
</head>
<body>
<style>
    html,
    body {
        margin: 0;
        background-color: transparent;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
</style>
<script>
  // class AdClickDetector {
  //   constructor(callback) {
  //     this.cb = callback;
  //   }
  //   monitor(iframeQuery, document) {
  //     if (this.tid) {
  //       clearInterval(this.tid);
  //       this.tid = null;
  //     }
  //     this.tid = setInterval(() => {
  //       if (!this.iframe) {
  //         this.iframe = document.querySelector(iframeQuery);
  //       }
  //       if (this.iframe && document.activeElement === this.iframe) {
  //         this.iframe.blur();
  //         this.cb();
  //       }
  //     }, 100);
  //   }
  // }
  // new URLSearchParams isn't supported on firefoxox based 48 (?)
  function getParameterByName(name) {
    const params = window.location.hash.substring(1).split("&");
    for (let i = 0; i < params.length; i++) {
      if (params[i].substring(0, name.length + 1) === name + "=") {
        return decodeURIComponent(params[i].substring(name.length + 1));
      }
    }
    return null;
  }

  window.kaiOpts = {
    appOrigin: getParameterByName("o"),
    reqWidth: getParameterByName("w"),
    reqHeight: getParameterByName("h"),
    frameID: getParameterByName("fid"),
    fullscreen: getParameterByName("fullscreen"),
    advid: getParameterByName("advid"),
    imsi: getParameterByName("imsi"),
    uid: getParameterByName("uid"),
    adspot: getParameterByName("adspot"),
    pkg: getParameterByName("pkg"),
    adref: getParameterByName("adref"),
    cdata: getParameterByName("cdata"),
  };

  let viewabilityCheckOrigin = "";
  const postViewability = (parentArgs) => {
    if (!window.frames[0] || viewabilityCheckOrigin === '') {
      return;
    }

    const frame = document.querySelector("iframe");
    if (!frame) {
      return;
    }
    const rect = frame.getBoundingClientRect();

    frame.contentWindow.postMessage(
      JSON.stringify({
        event: "viewability",
        args: [
          [
            rect.top,
            rect.left,
            rect.right,
            rect.bottom,
            rect.width,
            rect.height,
            window.innerWidth,
            window.innerHeight,
          ],
          parentArgs
        ]
      }),
      viewabilityCheckOrigin
    );
    viewabilityCheckOrigin = '';
  };

  const onKeyDown = (key) => {
    if (
      window.kaiOpts.fullscreen === "1" &&
      ["Backspace", "EndCall", "SoftRight"].indexOf(key) >= 0
    ) {
      window.parent.postMessage(
        JSON.stringify({
          frameID: window.kaiOpts.frameID,
          event: "close",
          args: [],
        }),
        window.kaiOpts.appOrigin
      );
    }
  };
  window.addEventListener("keydown", (e) => {
    onKeyDown(e.key);
  });
  window.addEventListener("message", (e) => {
    console.log(e);
    if (e.origin !== window.kaiOpts.appOrigin) {
      return;
    }
    const payload = JSON.parse(e.data);
    if (payload.event === "keydown") {
      onKeyDown(payload.args[0]);
    }
    if (payload.event === "viewability") {
      // forward the viewability calls to iframes
      postViewability(payload.args);
    }
  });

  window.addEventListener("message", (e) => {
    console.log(e);

    let payload;
    try {
      payload = JSON.parse(e.data);
    } catch (err) {
      return;
    }
    if (!payload || !payload.event) {
      return;
    }
    if (payload.event === "postCheckViewability") {
      viewabilityCheckOrigin = e.origin;
      console.log("appOrigin = " + window.kaiOpts.appOrigin)
      window.parent.postMessage(
        JSON.stringify({
          frameID: window.kaiOpts.frameID,
          event: "viewability",
          args: [],
        }),
        window.kaiOpts.appOrigin
      );
    }
  });
</script>
<!--<script src="https://jioads.akamaized.net/betasdk/kaiDisplayAds/KaiOSSDK/vmaxsdk.js"></script>-->
<script src="https://firegnu.github.io/gems-test/remote/vmaxsdk.js"></script>
<div id="div-gpt-ad-1589095880942-0" style="width: 100%; height: 100%">
  <iframe src="https://example.com/" style="width: 100%; height: 100%"></iframe>
</div>
<ins id="pid-1" class="adsbyvmax" data-adspot-key="" data-source=""></ins>
<script>
  // var ins = document.getElementById("pid-1");
  // ins.dataset.adspotKey = window.kaiOpts.adspot;
  // ins.dataset.source = window.kaiOpts.pkg;
  // if(window.kaiOpts.adref){
  //   ins.dataset.refreshAfter = window.kaiOpts.adref;
  // }
  // if(window.kaiOpts.cdata){
  //   ins.dataset.setcustomdata = window.kaiOpts.cdata;
  // }
  // VMAX.setAppVersion("1.0");
  // //VMAX.setAppName(document.getElementById("pid-1").getAttribute('data-source'));
  // VMAX["deviceInfo"]["uid"] = window.kaiOpts.uid;
  // VMAX["deviceInfo"]["imsi"] = window.kaiOpts.imsi;
  // // set video container in which ad will play //
  // VMAX.setVideoPlayerDetails("div-gpt-ad-1589095880942-0");
  // VMAX.orientation = 'l';
  // VMAX.onAdReady = function(placementId, adUXType, adMetadata) {
  //   console.log("Callback onAdReady...", placementId, adUXType, adMetadata);
  //   VMAX.showAd(placementId);
  // };
  //
  // VMAX.onAdError = function(placementId, errorString) {
  //   console.log("oops something went wrong" + JSON.stringify(errorString));
  //   var msg = {
  //     frameID: window.kaiOpts.frameID,
  //     event: "close",
  //     args: [],
  //   };
  //   window.parent.postMessage(
  //     JSON.stringify(msg),
  //     window.kaiOpts.appOrigin
  //   );
  // };
  //
  // VMAX.onAdClose = function(placementId) {
  //   console.log("Ad Closed++++", placementId);
  //   var msg = {
  //     frameID: window.kaiOpts.frameID,
  //     event: "close",
  //     args: [],
  //   };
  //   window.parent.postMessage(
  //     JSON.stringify(msg),
  //     window.kaiOpts.appOrigin
  //   );
  // };
  // VMAX.onAdMediaStart = function(placementId) {
  //   console.info("CB: Callback onAdMediaStart ...", placementId);
  // };
  //
  // VMAX.onAdMediaEnd = function(placementId) {
  //   console.info("CB: Callback onAdMediaEnd ...", placementId);
  // };
  //
  // VMAX.onAdClick = function(placementId) {
  //   console.info("CB: Callback onAdClick ...", placementId);
  //   window.close();
  //   var msg = {
  //     frameID: window.kaiOpts.frameID,
  //     event: "close",
  //     args: [],
  //   };
  //   window.parent.postMessage(
  //     JSON.stringify(msg),
  //     window.kaiOpts.appOrigin
  //   );
  // };
  // VmaxUserData.setDefaultIMSI(window.kaiOpts.imsi);
  // VmaxUserData.setIDFA(window.kaiOpts.advid);
  // VMAX.cacheAd('pid-1');
</script>
<!-- <script>
  new AdClickDetector(() => {
    window.parent.postMessage(
      JSON.stringify({
        frameID: window.kaiOpts.frameID,
        event: "click",
        args: [],
      }),
      window.kaiOpts.appOrigin
    );
  }).monitor("div#div-gpt-ad-1589095880942-0 iframe", document);
</script> -->
</body>
</html>
